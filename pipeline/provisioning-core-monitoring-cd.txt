steps:
- task: ExtractFiles@1
  displayName: 'Extract files '
  inputs:
    archiveFilePatterns: '$(System.ArtifactsDirectory)\**\*.zip'
    destinationFolder: '$(System.ArtifactsDirectory)\_Extracted\provisioning'
steps:
- task: NuGetCommand@2
  displayName: 'NuGet Install NHH DevOps Powershell'
  inputs:
    command: custom
    arguments: 'install NHH.DevOps.PowerShell -Source https://nottinghill.pkgs.visualstudio.com/_packaging/core/nuget/v3/index.json -OutputDirectory $(System.ArtifactsDirectory)\_Extracted\Powershell'
steps:
- task: jessehouwing.jessehouwing-vsts-variable-tasks.vsts-variable-transform.VariableTransformTask@1
  displayName: 'Transform Value ''$(Release.EnvironmentName)'''
  inputs:
    value: '$(Release.EnvironmentName)'
    variableName: Runtime.Core.EnvironmentNameShort
    searchReplace: false
    trim: false
    slice: false
    substring: true
    substringType: left
    substringLength: 1
    casing: true
    casingType: toLower
    pad: false
steps:
- task: qetza.replacetokens.replacetokens-task.replacetokens@2
  displayName: 'Replace Tokens'
  inputs:
    rootDirectory: '$(System.ArtifactsDirectory)\_Extracted'
    targetFiles: '**\*.ARM.Params.json'
    actionOnMissing: fail
    tokenSuffix: '}'
  continueOnError: true
steps:
- task: PowerShell@1
  displayName: 'View Configuration'
  inputs:
    scriptType: inlineScript
    inlineScript: 'Get-Content -Path $(System.ArtifactsDirectory)\_Extracted\provisioning\Core.*.ARM.Params.json'
#Your build pipeline references an undefined variable named ‘Provisioning.Monitoring.ResourceGroupName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972

steps:
- task: AzureResourceManagerTemplateDeployment@3
  displayName: 'Azure Deployment:Create Or Update Resource Group action on $(Provisioning.Monitoring.ResourceGroupName)'
  inputs:
    azureResourceManagerConnection: 'NHG Digital NON-PROD (dc8ebcd8-c1cc-43d3-a734-529dc0e858b4)'
    subscriptionId: 'dc8ebcd8-c1cc-43d3-a734-529dc0e858b4'
    resourceGroupName: '$(Provisioning.Monitoring.ResourceGroupName)'
    location: 'UK South'
    csmFile: '$(System.ArtifactsDirectory)\_Extracted\provisioning\Core.*.ARM.json'
    csmParametersFile: '$(System.ArtifactsDirectory)\_Extracted\provisioning\Core.*.ARM.Params.json'

    #Your build pipeline references an undefined variable named ‘Provisioning.Monitoring.StorageAccount’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Provisioning.Monitoring.ResourceGroupName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972

steps:
- task: AzurePowerShell@5
  displayName: 'Azure PowerShell: Create AppInsights Export Container'
  inputs:
    azureSubscription: 'NHG Digital NON-PROD (dc8ebcd8-c1cc-43d3-a734-529dc0e858b4)'
    ScriptPath: '$(System.ArtifactsDirectory)\_Extracted\Powershell\**\Release\New-StorageAccountContainer.ps1'
    ScriptArguments: '-storageAccountName $(Provisioning.Monitoring.StorageAccount) -resourceGroupName $(Provisioning.Monitoring.ResourceGroupName) -containerName applicationinsightsexport -permission Off'
    azurePowerShellVersion: LatestVersion
